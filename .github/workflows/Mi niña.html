<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¬°Feliz dia  Mi NI√±aaaa fdelores amarillas!‚ù§Ô∏èüåª</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/icon.png">


    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --bg-image: url('https://www.dl.dropboxusercontent.com/scl/fi/mc9hgtyin3t8g2bjp9jyj/back4.png?rlkey=z2cd4sc9uvgxl0sm34nrpcr7t&st=fk6s2vrv');
            --bg-blur-amount: 4px;
            --bg-overlay-color: rgba(224, 224, 224, 0.222);
            --primary-color: #FF6347;
            --primary-glow: #FF4500;
            --click-me-color: #FFFFFF;
            --click-me-glow: #ff9933;
            --text-color-light: #ffffff;
            --text-shadow: rgba(0, 0, 0, 0.5);
            --modal-bg: rgba(0, 0, 0, 0.3);
            --modal-backdrop-blur: 12px;
            --modal-border-color: rgba(255, 255, 255, 0.4);
            --modal-shadow: rgba(0, 0, 0, 0.25);
            --image-border-color: rgba(255, 255, 255, 0.9);
            --image-shadow-color: rgba(0, 0, 0, 0.2);
            --title-text-color: var(--text-color-light);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            font-family: 'Sour Gummy', sans-serif; 
            position: relative; 
        }
        
        body { 
            background-image: var(--bg-image); 
            background-size: cover; 
            background-position: center center; 
            background-attachment: fixed;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Sintaxis est√°ndar */
            -webkit-tap-highlight-color: transparent; /* Elimina el resaltado al tocar en m√≥viles */
        }
        
        body::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-overlay-color); backdrop-filter: blur(var(--bg-blur-amount)); z-index: 0; }
        
        #loader-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: linear-gradient(135deg, #FFDAB9, #FFB6C1); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
            transition: opacity 1s ease-out, visibility 1s ease-out; 
            opacity: 1; 
            visibility: visible; 
        }
        #loader-container.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .loader-content { text-align: center; }
        .loader-heart { 
            width: 80px; 
            height: 80px; 
            background-color: var(--primary-color); 
            position: relative; 
            transform: rotate(-45deg); 
            margin: 0 auto 50px auto; 
            animation: heart-pulse-intense 1.2s ease-in-out infinite; 
        }
        .loader-heart::before, .loader-heart::after { 
            content: ''; 
            width: 80px; 
            height: 80px; 
            background-color: var(--primary-color); 
            border-radius: 50%; 
            position: absolute; 
        }
        .loader-heart::before { top: -40px; left: 0; }
        .loader-heart::after { top: 0; left: 40px; }
        
        @keyframes heart-pulse-intense { 
            0% { 
                transform: rotate(-45deg) scale(1); 
                filter: brightness(1);
            } 
            50% { 
                transform: rotate(-45deg) scale(1.15); 
                filter: brightness(1.2);
                box-shadow: 0 0 20px rgba(255, 99, 71, 0.6);
            } 
            100% { 
                transform: rotate(-45deg) scale(1); 
                filter: brightness(1);
            } 
        }
        
        .progress-bar-container { width: 280px; height: 10px; border: 2px solid var(--primary-color); border-radius: 8px; overflow: hidden; margin-bottom: 20px; background: rgba(255, 255, 255, 0.2); }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--primary-glow)); border-radius: 8px; transition: width 0.4s ease-out; }
        #progress-text { 
            color: #333; 
            font-family: 'Sour Gummy', sans-serif; 
            font-size: 1.1rem;
            font-weight: 500;
        }

        canvas#bg { position: fixed; top: 0; left: 0; z-index: 1; cursor: grab; }
        canvas#bg:active { cursor: grabbing; }

        .click-me-container { 
            position: fixed; 
            bottom: 10%; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 2; 
            text-align: center; 
            opacity: 0; 
            transition: opacity 1.5s ease-in; 
        }
        
        #clickMeText { 
            color: var(--click-me-color); 
            font-family: 'Dancing Script', cursive; 
            font-size: 4.8rem; 
            cursor: pointer; 
            text-shadow: 
                0 0 8px #fff, 
                0 0 18px #fff, 
                0 0 28px var(--click-me-glow), 
                0 0 38px var(--click-me-glow),
                0 0 48px var(--click-me-glow); 
            transition: all 0.3s ease-in-out; 
            animation: heartbeat-intense 1.4s ease-in-out infinite; 
            font-weight: 700;
        }
        
        #clickMeText:hover { 
            text-shadow: 
                0 0 12px #fff, 
                0 0 28px var(--click-me-glow), 
                0 0 48px var(--click-me-glow),
                0 0 68px var(--click-me-glow); 
            transform: scale(1.08);
        }
        
        @keyframes heartbeat-intense { 
            0% { 
                transform: scale(1); 
                filter: brightness(1);
            } 
            14% { 
                transform: scale(1.12); 
                filter: brightness(1.15);
            } 
            28% { 
                transform: scale(1); 
                filter: brightness(1);
            } 
            42% { 
                transform: scale(1.12); 
                filter: brightness(1.15);
            } 
            70% { 
                transform: scale(1); 
                filter: brightness(1);
            } 
        }
        
        .modal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.6s ease; }
        .modal-container.active { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background-color: var(--modal-bg);
            backdrop-filter: blur(var(--modal-backdrop-blur)); -webkit-backdrop-filter: blur(var(--modal-backdrop-blur));
            padding: 40px 50px; border-radius: 30px;
            box-shadow: 0 15px 50px var(--modal-shadow);
            max-width: 920px; width: 90%;
            position: relative; transform: scale(0.9);
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid var(--modal-border-color);
            max-height: 85vh; overflow-y: auto;
            display: flex; flex-direction: column;
        }

        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb:hover { background: var(--primary-glow); }

        .modal-container.active .modal-content { transform: scale(1); }
        .close-button { 
            position: absolute; 
            top: 15px; 
            right: 25px; 
            font-size: 2.5rem; 
            color: var(--text-color-light); 
            cursor: pointer; 
            transition: color 0.3s, transform 0.3s; 
            text-shadow: 0 0 8px var(--text-shadow); 
            z-index: 20; 
            font-family: 'Sour Gummy', sans-serif;
        }
        .close-button:hover { color: var(--primary-color); transform: rotate(90deg); }
        .modal-content h1 { 
            font-family: 'Sour Gummy', sans-serif;
            color: var(--title-text-color); 
            text-align: center; 
            font-size: 3.2rem; 
            margin-bottom: 25px; 
            text-shadow: 0 2px 8px var(--text-shadow); 
        }
        
        .music-player-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 25px;
            padding: 20px;
            margin-bottom: 30px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .album-cover-container { width: 100%; display: flex; justify-content: center; position: relative; }
        #album-cover { 
            width: 200px; 
            height: 200px; 
            border-radius: 15px; 
            box-shadow: 0 0 25px var(--image-shadow-color); 
            animation: pulse-album 2.2s infinite; 
            transition: transform 0.3s ease;
        }
        #album-cover:hover { transform: scale(1.05); }
        @keyframes pulse-album { 
            0% { transform: scale(1); box-shadow: 0 0 25px var(--image-shadow-color); } 
            50% { transform: scale(1.03); box-shadow: 0 0 35px rgba(255, 99, 71, 0.4); } 
            100% { transform: scale(1); box-shadow: 0 0 25px var(--image-shadow-color); } 
        }
        
        .song-info { text-align: center; color: var(--text-color-light); margin-top: 15px; }
        .song-title { 
            font-size: 1.3rem; 
            font-weight: 600; 
            margin: 0; 
            text-shadow: 0 1px 3px var(--text-shadow); 
            font-family: 'Sour Gummy', sans-serif;
        }
        .artist-name { 
            font-size: 1rem; 
            color: #b3b3b3; 
            margin: 5px 0; 
            text-shadow: 0 1px 3px var(--text-shadow); 
            font-family: 'Sour Gummy', sans-serif;
            font-weight: 400;
        }
        .progress-container { width: 100%; margin-top: 18px; position: relative; }
        .progress-bar-wrapper { 
            width: 100%; 
            height: 6px;
            background-color: rgba(255, 255, 255, 0.25); 
            border-radius: 5px; 
            cursor: pointer; 
            position: relative; 
            margin: 8px 0;
        }
        #musicProgressBar { width: 0%; height: 100%; background: var(--primary-color); border-radius: 5px; transition: width 0.1s linear; }
        .progress-thumb { 
            width: 16px; 
            height: 16px; 
            background-color: var(--primary-color); 
            border-radius: 50%; 
            position: absolute; 
            top: 50%; 
            left: 0%; 
            transform: translate(-50%, -50%); 
            cursor: pointer; 
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
            opacity: 1;
            z-index: 10;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .progress-thumb:hover { 
            transform: translate(-50%, -50%) scale(1.2); 
            box-shadow: 0 3px 12px rgba(255, 99, 71, 0.4);
        }
        
        .progress-thumb:active { 
            transform: translate(-50%, -50%) scale(1.3); 
            box-shadow: 0 4px 16px rgba(255, 99, 71, 0.6);
        }
        
        .progress-bar-wrapper:hover .progress-thumb { opacity: 1; }
        .progress-time { 
            display: flex; 
            justify-content: space-between; 
            color: #b3b3b3; 
            font-size: 0.95rem; 
            margin-top: 8px; 
            font-family: 'Sour Gummy', sans-serif;
            font-weight: 400;
        }
        
        .controls { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 300px; margin-top: 22px; }
        .control-btn { 
            background: none; 
            border: none; 
            color: var(--text-color-light); 
            font-size: 1.5rem; 
            cursor: pointer; 
            transition: color 0.3s ease, transform 0.2s ease; 
            padding: 8px;
            border-radius: 50%;
        }
        .control-btn.play-pause { font-size: 2.2rem; }
        .control-btn:hover { 
            color: var(--primary-glow); 
            transform: scale(1.1);
        }
        .control-btn.active { color: var(--primary-color); }

        .modal-body { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .text-content p { 
            font-family: 'Sour Gummy', sans-serif; 
            font-size: 1.2rem; 
            line-height: 1.8; 
            color: var(--text-color-light); 
            margin-bottom: 20px; 
            text-shadow: 0 2px 5px var(--text-shadow); 
            text-align: center; 
            font-weight: 400;
        }
        
        .carousel-section { width: 100%; perspective: 1200px; min-height: 380px; display: flex; justify-content: center; align-items: center; margin-top: 15px; }
        .carousel-container-3d { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; }
        .carousel-3d { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: grab; touch-action: none; }
        .carousel-3d:active { cursor: grabbing; }
        .carousel-item-3d { position: absolute; top: 0; left: 0; right: 0; bottom: 0; margin: auto; width: 240px; height: 330px; transform-style: preserve-3d; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px var(--image-shadow-color); border: 3px solid var(--image-border-color); background: #000; }
        .carousel-item-3d img { width: 100%; height: 100%; object-fit: cover; border-radius: 15px; user-select: none; pointer-events: none; -webkit-box-reflect: below 1px linear-gradient(transparent, transparent, rgba(0,0,0,0.2)); }
        
        .date-signature { 
            text-align: center; 
            margin-top: 30px; 
            font-family: 'Sour Gummy', sans-serif; 
            font-weight: 600; 
            font-size: 1.15rem; 
            letter-spacing: 1px; 
            color: var(--text-color-light); 
            opacity: 0.9; 
            text-shadow: 0 1px 4px var(--text-shadow); 
        }

        @media (max-width: 850px) {
            .modal-content h1 { font-size: 2.9rem; }
            .carousel-section { min-height: 300px; perspective: 1000px; }
            .carousel-item-3d { width: 190px; height: 260px; }
            #album-cover { width: 180px; height: 180px; }
            #clickMeText { font-size: 4.0rem; }
        }
        @media (max-width: 480px) {
            :root { --bg-blur-amount: 2px; }
            .modal-content { padding: 35px 20px 25px 20px; width: 95%; }
            .modal-content h1 { font-size: 2.5rem; }
            .text-content p { font-size: 1.05rem; }
            .close-button { top: 10px; right: 15px; }
            .date-signature { font-size: 1.05rem; }
            .carousel-section { min-height: 250px; perspective: 800px; }
            .carousel-item-3d { width: 160px; height: 220px; }
            #album-cover { width: 150px; height: 150px; }
            .control-btn { font-size: 1.2rem; }
            .control-btn.play-pause { font-size: 1.9rem; }
            #clickMeText { font-size: 3.6rem; }
        }
    </style>
</head>
<body>
    <div id="loader-container">
        <div class="loader-content">
            <div class="loader-heart"></div>
            <div class="progress-bar-container"><div id="progress-bar"></div></div>
            <p id="progress-text">CARGANDO TU LOOT MI NI√ëA üòô‚ù§Ô∏è <span id="progress-percent">0%</span></p>
        </div>
    </div>
    <canvas id="bg"></canvas>
    <audio id="musicPlayer"></audio>

    <div class="click-me-container"><h2 id="clickMeText">¬°TOCA TUS FLORES COZHITA!‚ù§Ô∏è</h2></div>

    <div id="modalContainer" class="modal-container">
        <div class="modal-content">
            <span class="close-button">√ó</span>
            <p></p>
            <h1>¬°PARA TI MI NI√ëA BONITA! ‚ù§Ô∏è <P> ‚ù§Ô∏èüåª¬°FELIZ 21 DE SEPTIEMBRE!üåª‚ù§Ô∏è</P></h1>
        
            <div class="music-player-container">
                <div class="album-cover-container">
                    <img id="album-cover" src="images/song1.jpeg" alt="Album Cover">
                </div>
                <div class="song-info">
                    <h2 id="song-title" class="song-title">Those Eyes</h2>
                    <p id="artist-name" class="artist-name">New West</p>
                </div>
                <div class="progress-container">
                    <div class="progress-bar-wrapper">
                        <div id="musicProgressBar"></div>
                        <div class="progress-thumb"></div>
                    </div>
                    <div class="progress-time">
                        <span id="current-time">0:00</span>
                        <span id="total-time">0:00</span>
                    </div>
                </div>
                <div class="controls">
                    <button class="control-btn shuffle"><i class="fas fa-random"></i></button>
                    <button class="control-btn prev"><i class="fas fa-backward"></i></button>
                    <button class="control-btn play-pause"><i class="fas fa-play"></i></button>
                    <button class="control-btn next"><i class="fas fa-forward"></i></button>
                    <button class="control-btn repeat"><i class="fas fa-redo"></i></button>
                </div>
            </div>

            <div class="modal-body">
                <div class="text-content">
                    <p>Mi ni√±a üíï, cada d√≠a contigo es como entrar a mi partida favorita,
                        siempre hay risas, complicidad y momentos que se quedan grabados en m√≠.
                        Eres mi mejor LOOT, mi top de agua y la raz√≥n por la que hasta el chisme
                         antes de jugar se vuelve especial ü§≠.
                          <p>Gracias por tu confianza üíñ, disculpa si a veces no me
                           comporto de la mejor manera o de manera fria üòî, pero despu√©s de mucho tiempo vuelvo
                            a sentir un cari√±o real por alguien‚Ä¶. Contigo no solo 
                            disfruto la conversaci√≥n, tambi√©n el juego se vuelve m√°s divertido üòè‚ù§Ô∏è; 
                            las partidas dejan de ser simples partidas y se transforman en recuerdos que 
                            quiero seguir acumulando contigo ‚ú®.</p><p>
                            Antes que jugaramos por primera vez yo quer√≠a darme un tiempo del juego, 
                            ya no lo disfrutaba como antes‚Ä¶ pero contigo todo cambi√≥, empec√© a 
                            divertirme de nuevo, a re√≠r y a sentir que cada partida ten√≠a algo 
                            especial solo por estar a tu lado.
                            No necesariamente me importa ganar cuando jugamos porque solo disfruto jugar, porque t√∫ eres mi partida ganada
                             desde el inicio üíò. A veces siento que soy yo el que anda haci√©ndose ilusiones tontas y si te llegas aburrir de mi
                             te voy entender igual no soy tan woww üòÖ‚Ä¶. <p>TE QUIERO MUCHO üíû m√°s
                              de lo que cualquier palabra o jugada podr√≠a demostrar.</p></p></p>
                </div>
                <div class="carousel-section">
                    <div class="carousel-container-3d">
                        <div class="carousel-3d" id="imageCarousel">
                            <div class="carousel-item-3d"><img src="https://i.ibb.co/fV9tPwsY/a1.png" alt="Recuerdo 1"></div>
                            <div class="carousel-item-3d"><img src="https://i.ibb.co/HDBWBHbg/a2.png" alt="Recuerdo 2"></div>
                            <div class="carousel-item-3d"><img src="https://i.ibb.co/MHtytPb/a3.png" alt="Recuerdo 3"></div>
                            <div class="carousel-item-3d"><img src="https://i.ibb.co/v46PG0fj/a7.jpg" alt="Recuerdo 4"></div>
                            <div class="carousel-item-3d"><img src="https://i.ibb.co/3mG4tRTg/a8.jpg" alt="Recuerdo 5"></div>
                            <div class="carousel-item-3d"><img src="https://i.ibb.co/mCg9yNg9/a6.jpg" alt="Recuerdo 6"></div>
                        </div>
                    </div>
                </div>
            </div>
            <p class="date-signature"> </p>
        </div>
    </div>

<script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.166.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.166.0/examples/jsm/" } }</script>
<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    
    const loaderContainer = document.getElementById('loader-container');
    const progressBar = document.getElementById('progress-bar');
    const progressPercent = document.getElementById('progress-percent');
    const clickMeContainer = document.querySelector('.click-me-container');
    
    let progress = 0;
    let modelLoaded = false;
    let sceneReady = false;
    
    const interval = setInterval(() => { 
        // Progreso simulado hasta 60%
        if (progress < 60) {
            progress += Math.random() * 8; 
            if (progress > 60) progress = 60;
        }
        // Esperar a que el modelo est√© cargado para completar
        else if (modelLoaded && sceneReady) {
            progress += Math.random() * 15;
            if (progress > 100) progress = 100;
        }
        
        progressBar.style.width = progress + '%'; 
        progressPercent.textContent = Math.floor(progress) + '%'; 
        
        // Completar carga cuando llegue al 100%
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => { 
                loaderContainer.classList.add('hidden'); 
                clickMeContainer.style.opacity = '1'; 
            }, 800); 
        }
    }, 300);
    
    let renderer, scene, camera;
    let heartModel = null;
    let lightParticles;
    
    let isMouseDown = false;
    let previousMousePosition = { x: 0, y: 0 };
    let modelRotationVelocity = { x: 0, y: 0 }; 
    const autoRotationSpeed = 0.003;

    function createParticleTexture() { 
        const canvas = document.createElement('canvas'); 
        canvas.width = 64; 
        canvas.height = 64; 
        const context = canvas.getContext('2d'); 
        const gradient = context.createRadialGradient(32, 32, 0, 32, 32, 32); 
        gradient.addColorStop(0, 'rgba(255,255,255,1)'); 
        gradient.addColorStop(0.2, 'rgba(255,255,255,0.8)'); 
        gradient.addColorStop(0.8, 'rgba(255,255,255,0.1)'); 
        gradient.addColorStop(1, 'rgba(255,255,255,0)'); 
        context.fillStyle = gradient; 
        context.fillRect(0, 0, 64, 64); 
        return new THREE.CanvasTexture(canvas); 
    }

    function init3D() {
        scene = new THREE.Scene(); 
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000); 
        
        camera.position.set(0, 1, 8); 
        camera.lookAt(0, 1, 0); 
        
        renderer = new THREE.WebGLRenderer({ canvas: document.querySelector('#bg'), alpha: true, antialias: true }); 
        renderer.setPixelRatio(window.devicePixelRatio); 
        renderer.setSize(window.innerWidth, window.innerHeight); 
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8); 
        scene.add(ambientLight);
        
        const keyLight = new THREE.DirectionalLight(0xffd700, 1.8); 
        keyLight.position.set(-10, 10, 5); 
        keyLight.castShadow = true;
        keyLight.shadow.mapSize.width = 2048;
        keyLight.shadow.mapSize.height = 2048;
        scene.add(keyLight);
        
        const fillLight = new THREE.DirectionalLight(0xff6b9d, 1.0);
        fillLight.position.set(10, 5, 2);
        scene.add(fillLight);
        
        const rimLight = new THREE.DirectionalLight(0x9d50ff, 0.7);
        rimLight.position.set(0, -10, -5);
        scene.add(rimLight);

        const loader = new GLTFLoader();
        loader.load(
            'https://www.dl.dropboxusercontent.com/scl/fi/2y4ih0ut9vifd0v2zdevy/Flower.glb?rlkey=8ddf735p0pqx7ijz3av460shr&st=oos72t6b',
            function (gltf) {
                const loadedModel = gltf.scene;
                const pivot = new THREE.Group();
                scene.add(pivot);

                const box = new THREE.Box3().setFromObject(loadedModel);
                const center = new THREE.Vector3();
                box.getCenter(center);
                loadedModel.position.sub(center);

                pivot.add(loadedModel);
                
                heartModel = pivot;
                
                heartModel.scale.set(5, 5, 5);
                heartModel.position.set(0, 1, 5);

                loadedModel.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });

                // Marcar modelo como cargado
                modelLoaded = true;
                console.log("Modelo 3D cargado correctamente");
            },
            function (progress) {
                // Mostrar progreso de carga del modelo
                const percentLoaded = (progress.loaded / progress.total) * 100;
                console.log('Progreso del modelo: ' + Math.round(percentLoaded) + '%');
            },
            function (error) {
                console.error('Error al cargar el modelo "Flower.glb". Aseg√∫rate de que la ruta es correcta.', error);
                createFallbackHeart();
                modelLoaded = true; // Marcar como cargado incluso si falla
            }
        );

        const envMapLoader = new THREE.CubeTextureLoader();
        const envMap = envMapLoader.load([
            'https://threejs.org/examples/textures/cube/Park3Med/px.jpg', 'https://threejs.org/examples/textures/cube/Park3Med/nx.jpg',
            'https://threejs.org/examples/textures/cube/Park3Med/py.jpg', 'https://threejs.org/examples/textures/cube/Park3Med/ny.jpg',
            'https://threejs.org/examples/textures/cube/Park3Med/pz.jpg', 'https://threejs.org/examples/textures/cube/Park3Med/nz.jpg'
        ]);
        scene.environment = envMap;

        const particleTexture = createParticleTexture(); 
        const particlesGeometry = new THREE.BufferGeometry(); 
        const particlesCount = 5000; 
        const posArray = new Float32Array(particlesCount * 3); 
        for (let i = 0; i < particlesCount * 3; i++) { 
            posArray[i] = (Math.random() - 0.5) * (i % 3 === 1 ? 50 : 40); 
        } 
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3)); 
        const particlesMaterial = new THREE.PointsMaterial({ 
            map: particleTexture, size: 0.15, blending: THREE.AdditiveBlending, 
            transparent: true, depthWrite: false, opacity: 0.9, sizeAttenuation: true 
        }); 
        lightParticles = new THREE.Points(particlesGeometry, particlesMaterial); 
        scene.add(lightParticles);

        // Marcar escena como lista
        sceneReady = true;

        function createFallbackHeart() {
            const heartShape = new THREE.Shape();
            const x = -2.5, y = -5;
            heartShape.moveTo(x + 2.5, y + 2.5);
            heartShape.bezierCurveTo(x + 2.5, y + 2.5, x + 2, y, x, y);
            heartShape.bezierCurveTo(x - 3, y, x - 3, y + 3.5, x - 3, y + 3.5);
            heartShape.bezierCurveTo(x - 3, y + 5.5, x - 1.5, y + 7.7, x + 2.5, y + 9.5);
            heartShape.bezierCurveTo(x + 6, y + 7.7, x + 8, y + 5.5, x + 8, y + 3.5);
            heartShape.bezierCurveTo(x + 8, y + 3.5, x + 8, y, x + 5, y);
            heartShape.bezierCurveTo(x + 3.5, y, x + 2.5, y + 2.5, x + 2.5, y + 2.5);
            const extrudeSettings = { steps: 8, depth: 2.5, bevelEnabled: true, bevelThickness: 0.8, bevelSize: 0.5, bevelOffset: -0.1, bevelSegments: 32 };
            const geometry = new THREE.ExtrudeGeometry(heartShape, extrudeSettings);
            const material = new THREE.MeshPhysicalMaterial({ color: 0xef2b4c, metalness: 0.3, roughness: 0.2, clearcoat: 0.8, clearcoatRoughness: 0.2, emissive: 0x661122, emissiveIntensity: 0.6, envMapIntensity: 1.0 });
            
            heartModel = new THREE.Mesh(geometry, material);
            heartModel.scale.set(0.06, 0.06, 0.06);
            heartModel.position.set(0, 1, 0);
            heartModel.rotation.x = Math.PI;
            heartModel.castShadow = true;
            heartModel.receiveShadow = true;
            scene.add(heartModel);
        }

        const canvas = renderer.domElement;

        function handleDragStart(clientX, clientY) {
            if (isModalOpen) return;
            isMouseDown = true;
            previousMousePosition = { x: clientX, y: clientY };
            modelRotationVelocity = { x: 0, y: 0 };
            canvas.style.cursor = 'grabbing';
        }

        function handleDragMove(clientX, clientY) {
            if (!isMouseDown || isModalOpen || !heartModel) return;

            const deltaX = clientX - previousMousePosition.x;
            heartModel.rotation.y += deltaX * 0.005;
            modelRotationVelocity = { x: 0, y: deltaX * 0.005 };
            previousMousePosition = { x: clientX, y: clientY };
        }

        function handleDragEnd() {
            isMouseDown = false;
            canvas.style.cursor = 'grab';
        }
        
        canvas.addEventListener('mousedown', (e) => handleDragStart(e.clientX, e.clientY));
        canvas.addEventListener('mousemove', (e) => handleDragMove(e.clientX, e.clientY));
        document.addEventListener('mouseup', handleDragEnd);
        canvas.addEventListener('mouseleave', handleDragEnd);

        canvas.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                e.preventDefault();
                handleDragStart(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1) {
                e.preventDefault();
                handleDragMove(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: false });

        canvas.addEventListener('touchend', handleDragEnd);
        canvas.addEventListener('touchcancel', handleDragEnd);

        const clock = new THREE.Clock();
        let isModalOpen = false;

        function animate() {
            requestAnimationFrame(animate);
            const elapsedTime = clock.getElapsedTime();

            if (heartModel) {
                const pulse = Math.sin(elapsedTime * 2.5) * 0.015 + 1;
                const baseScale = heartModel.userData.baseScale || { x: heartModel.scale.x, y: heartModel.scale.y, z: heartModel.scale.z };
                if (!heartModel.userData.baseScale) {
                    heartModel.userData.baseScale = { x: heartModel.scale.x, y: heartModel.scale.y, z: heartModel.scale.z };
                }
                heartModel.scale.set(baseScale.x * pulse, baseScale.y * pulse, baseScale.z * pulse);

                if (!isModalOpen && !isMouseDown) {
                    if (Math.abs(modelRotationVelocity.y) > 0.0001) {
                        heartModel.rotation.y += modelRotationVelocity.y;
                        modelRotationVelocity.y *= 0.95; 
                    } else {
                        heartModel.rotation.y += autoRotationSpeed;
                    }
                }
            }
            
            const particlePositions = lightParticles.geometry.attributes.position.array;
            for (let i = 0; i < particlesCount * 3; i+=3) {
                particlePositions[i + 1] += 0.02;
                if (particlePositions[i + 1] > 25) {
                    particlePositions[i + 1] = -25;
                    particlePositions[i] = (Math.random() - 0.5) * 40;
                }
            }
            lightParticles.geometry.attributes.position.needsUpdate = true;

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            if (!isModalOpen) { 
                renderer.setPixelRatio(window.devicePixelRatio); 
            }
        });

        animate();
        
        const modalContainer = document.getElementById('modalContainer');
        const clickMeText = document.getElementById('clickMeText');
        const closeButton = document.querySelector('.close-button');
        const music = document.getElementById('musicPlayer');
        let isFirstOpen = true;
        const playPauseBtn = document.querySelector('.play-pause');
        const prevBtn = document.querySelector('.prev');
        const nextBtn = document.querySelector('.next');
        const shuffleBtn = document.querySelector('.shuffle');
        const repeatBtn = document.querySelector('.repeat');
        const progressBarWrapper = document.querySelector('.progress-bar-wrapper');
        const musicProgressBar = document.getElementById('musicProgressBar');
        const progressThumb = document.querySelector('.progress-thumb');
        const currentTime = document.getElementById('current-time');
        const totalTime = document.getElementById('total-time');
        const albumCover = document.getElementById('album-cover');
        const songTitle = document.getElementById('song-title');
        const artistName = document.getElementById('artist-name');

        const songs = [
            { title: "Hoy no puedo darte las rosas personalmente üåπ ni pon√©rtelas en tus manos, pero las compr√© para tenerlas presentes, como s√≠mbolo que te quiero ‚ù§Ô∏è", artist: "‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è", cover: "https://www.dl.dropboxusercontent.com/scl/fi/4lyhzymglsh2rjc2hwxsw/song1.jpeg?rlkey=higl2ym6ksnfa2rv58a1fwf0w&st=n45h54q0", audio: "https://dl.dropboxusercontent.com/scl/fi/zs0it7wxiluaqh1omypoe/Como-tu-no-hay-dos.mp3?rlkey=3d10ex403w5w0l2147fbsb3gu&st=dobgnz7i " }, 
        //    { title: "When I Was Your Man", artist: "Bruno Mars", cover: "https://www.dl.dropboxusercontent.com/scl/fi/4lyhzymglsh2rjc2hwxsw/song1.jpeg?rlkey=higl2ym6ksnfa2rv58a1fwf0w&st=n45h54q0", audio: "https://www.dl.dropboxusercontent.com/scl/fi/ut3qvmpatxuh37vzbbvum/sound1.mp3?rlkey=9c7o5tkmyf9hb0uxab9eged39&st=4f50amj3" },
        //    { title: "Flores Amarillas", artist: "Floricienta", cover: "https://www.dl.dropboxusercontent.com/scl/fi/d2thqu8931mge04he97vt/song2.jpeg?rlkey=48wvj60qdks85p40kjwdfv7i1&st=0iyrpajc", audio: "https://www.dl.dropboxusercontent.com/scl/fi/e96pg8t3d3t71s9jd36wz/sound2.mp3?rlkey=u9bqefuupj7qns14gy6v4qjht&st=6yev3mbt" },
        ];

        let currentSongIndex = 0;
        let isDraggingMusic = false;
        let isShuffle = false;
        let isRepeat = false;
        let isLoading = false;
        let musicReady = false;

        function loadSong(index) {
            const song = songs[index];
            isLoading = true;
            musicReady = false;
            
            // Actualizar informaci√≥n visual inmediatamente
            albumCover.src = song.cover;
            songTitle.textContent = song.title;
            artistName.textContent = song.artist;
            
            // Resetear progreso visual
            musicProgressBar.style.width = '0%';
            progressThumb.style.left = '0%';
            currentTime.textContent = "0:00";
            
            // Cargar nueva canci√≥n
            music.src = song.audio;
            
            // Esperar a que se carguen los metadatos
            music.addEventListener('loadedmetadata', function onLoadedMetadata() {
                totalTime.textContent = formatTime(music.duration);
                music.removeEventListener('loadedmetadata', onLoadedMetadata);
            });
            
            music.addEventListener('canplaythrough', function onCanPlayThrough() {
                isLoading = false;
                musicReady = true;
                console.log("Canci√≥n lista para reproducir");
                music.removeEventListener('canplaythrough', onCanPlayThrough);
            });

            music.addEventListener('loadeddata', function onLoadedData() {
                isLoading = false;
                musicReady = true;
                music.removeEventListener('loadeddata', onLoadedData);
            });
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "0:00";
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
        
        function playMusic() { 
            if (musicReady && music.readyState >= 2) {
                music.play().then(() => {
                    console.log("M√∫sica reproduci√©ndose correctamente");
                }).catch(e => {
                    console.log("Error al reproducir:", e);
                    // Intentar reproducir despu√©s de interacci√≥n del usuario
                    document.addEventListener('click', function tryPlayAgain() {
                        music.play().then(() => {
                            console.log("M√∫sica reproduci√©ndose tras interacci√≥n");
                            document.removeEventListener('click', tryPlayAgain);
                        }).catch(console.log);
                    }, { once: true });
                }); 
            }
        }
        
        function pauseMusic() { 
            music.pause(); 
        }
        
        function playNextSong() {
            if (isShuffle) {
                let randomIndex;
                do { 
                    randomIndex = Math.floor(Math.random() * songs.length); 
                } while (songs.length > 1 && randomIndex === currentSongIndex);
                currentSongIndex = randomIndex;
            } else { 
                currentSongIndex = (currentSongIndex + 1) % songs.length; 
            }
            loadSong(currentSongIndex); 
            
            // Reproducir cuando est√© listo
            const playWhenReady = () => {
                if (musicReady) {
                    playMusic();
                } else {
                    setTimeout(playWhenReady, 100);
                }
            };
            playWhenReady();
        }

        function playPrevSong() {
            if (isShuffle) { 
                playNextSong(); 
            } else { 
                currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length; 
            }
            loadSong(currentSongIndex); 
            
            // Reproducir cuando est√© listo
            const playWhenReady = () => {
                if (musicReady) {
                    playMusic();
                } else {
                    setTimeout(playWhenReady, 100);
                }
            };
            playWhenReady();
        }

        function openModal() {
            if (!modalContainer.classList.contains('active')) {
                modalContainer.classList.add('active');
                isModalOpen = true;
                
                if (isFirstOpen) { 
                    // Asegurar que la m√∫sica se reproduzca autom√°ticamente
                    setTimeout(() => {
                        const attemptAutoplay = () => {
                            if (musicReady) {
                                playMusic();
                            } else {
                                setTimeout(attemptAutoplay, 100);
                            }
                        };
                        attemptAutoplay();
                    }, 500);
                    isFirstOpen = false; 
                }
                if (renderer) renderer.setPixelRatio(window.devicePixelRatio * 0.5);
            }
        }

        function closeModal() {
            if (modalContainer.classList.contains('active')) {
                modalContainer.classList.remove('active');
                isModalOpen = false;
                if (renderer) renderer.setPixelRatio(window.devicePixelRatio);
            }
        }

        clickMeText.addEventListener('click', openModal);
        closeButton.addEventListener('click', closeModal);
        modalContainer.addEventListener('dblclick', (e) => { 
            if (e.target === modalContainer) closeModal(); 
        });

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let dragOccurred = false;
        canvas.addEventListener('mousemove', () => { 
            if(isMouseDown) dragOccurred = true; 
        });
        canvas.addEventListener('mousedown', () => { 
            dragOccurred = false; 
        });
        
        window.addEventListener('click', (event) => {
            if (dragOccurred) {
                dragOccurred = false;
                return;
            }
            if (!isModalOpen) {
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                if (heartModel) {
                    const intersects = raycaster.intersectObject(heartModel, true);
                    if (intersects.length > 0) { openModal(); }
                }
            }
        }, false);
        
        // Event listeners del reproductor mejorados
        playPauseBtn.addEventListener('click', () => { 
            if (music.paused) { 
                playMusic(); 
            } else { 
                pauseMusic(); 
            } 
        });
        
        music.addEventListener('play', () => { 
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>'; 
        });
        
        music.addEventListener('pause', () => { 
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; 
        });
        
        music.addEventListener('timeupdate', () => {
            if (!isDraggingMusic && !isNaN(music.duration) && music.duration > 0) {
                const progress = (music.currentTime / music.duration) * 100;
                musicProgressBar.style.width = `${progress}%`;
                progressThumb.style.left = `${progress}%`;
                currentTime.textContent = formatTime(music.currentTime);
            }
        });
        
        music.addEventListener('loadedmetadata', () => { 
            totalTime.textContent = formatTime(music.duration); 
        });
        
        music.addEventListener('ended', () => { 
            if(isRepeat) { 
                music.currentTime = 0; 
                playMusic(); 
            } else { 
                playNextSong();
            } 
        });

        // Funci√≥n mejorada para saltar a cualquier parte de la canci√≥n
        function setProgress(e) {
            if (isNaN(music.duration) || music.duration <= 0) return;
            
            e.preventDefault();
            const rect = progressBarWrapper.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const width = rect.width;
            const percentage = Math.max(0, Math.min(100, (clickX / width) * 100));
            const newTime = (percentage / 100) * music.duration;
            
            // Actualizar posici√≥n visual inmediatamente
            musicProgressBar.style.width = `${percentage}%`;
            progressThumb.style.left = `${percentage}%`;
            currentTime.textContent = formatTime(newTime);
            
            // Establecer el tiempo de la canci√≥n
            music.currentTime = newTime;
        }

        // Event listeners mejorados para la barra de progreso
        progressBarWrapper.addEventListener('click', setProgress);
        
        // Mejorar el arrastre del thumb
        let startDragX = 0;
        
        progressThumb.addEventListener('mousedown', (e) => { 
            e.preventDefault();
            isDraggingMusic = true; 
            startDragX = e.clientX;
            document.addEventListener('selectstart', preventSelect);
        });
        
        function preventSelect(e) {
            e.preventDefault();
        }
        
        document.addEventListener('mousemove', (e) => {
            if (isDraggingMusic && !isNaN(music.duration) && music.duration > 0) {
                e.preventDefault();
                const rect = progressBarWrapper.getBoundingClientRect();
                let percentage = ((e.clientX - rect.left) / rect.width) * 100;
                percentage = Math.max(0, Math.min(100, percentage));
                
                musicProgressBar.style.width = `${percentage}%`;
                progressThumb.style.left = `${percentage}%`;
                currentTime.textContent = formatTime((percentage / 100) * music.duration);
            }
        });
        
        document.addEventListener('mouseup', (e) => { 
            if(isDraggingMusic) { 
                isDraggingMusic = false; 
                setProgress(e);
                document.removeEventListener('selectstart', preventSelect);
            } 
        });

        // Soporte t√°ctil mejorado para dispositivos m√≥viles
        progressBarWrapper.addEventListener('touchstart', (e) => {
            e.preventDefault();
            isDraggingMusic = true;
        }, { passive: false });

        progressBarWrapper.addEventListener('touchmove', (e) => {
            if (isDraggingMusic && !isNaN(music.duration) && music.duration > 0) {
                e.preventDefault();
                const rect = progressBarWrapper.getBoundingClientRect();
                const touch = e.touches[0];
                let percentage = ((touch.clientX - rect.left) / rect.width) * 100;
                percentage = Math.max(0, Math.min(100, percentage));
                
                musicProgressBar.style.width = `${percentage}%`;
                progressThumb.style.left = `${percentage}%`;
                currentTime.textContent = formatTime((percentage / 100) * music.duration);
            }
        }, { passive: false });

        progressBarWrapper.addEventListener('touchend', (e) => {
            if (isDraggingMusic) {
                e.preventDefault();
                isDraggingMusic = false;
                
                // Simular el evento de clic para establecer la posici√≥n final
                const rect = progressBarWrapper.getBoundingClientRect();
                const touch = e.changedTouches[0];
                const fakeEvent = {
                    clientX: touch.clientX,
                    preventDefault: () => {}
                };
                setProgress(fakeEvent);
            }
        }, { passive: false });

        nextBtn.addEventListener('click', playNextSong);
        prevBtn.addEventListener('click', playPrevSong);
        
        shuffleBtn.addEventListener('click', () => {
            isShuffle = !isShuffle; 
            shuffleBtn.classList.toggle('active', isShuffle); 
        });

        repeatBtn.addEventListener('click', () => {
            isRepeat = !isRepeat;
            repeatBtn.classList.toggle('active', isRepeat); 
        });

        // Cargar la primera canci√≥n al inicializar
        loadSong(currentSongIndex);

        const carousel = document.getElementById('imageCarousel');
        if (carousel) {
            const items = carousel.querySelectorAll('.carousel-item-3d'); 
            let radius, isCarouselDragging = false, startX = 0, currentRotation = 0, targetRotation = 0, autoRotateTimeout, animationFrameId; 
            const angle = 360 / items.length;
            
            const updateRadius = () => { 
                if (window.innerWidth <= 480) radius = 180; 
                else if (window.innerWidth <= 850) radius = 220; 
                else radius = 260; 
            };
            
            const arrangeItems = () => { 
                updateRadius(); 
                items.forEach((item, index) => { 
                    item.style.transform = `rotateY(${angle * index}deg) translateZ(${radius}px)`; 
                }); 
            };
            
            const dragStart = (e) => { 
                isCarouselDragging = true; 
                startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX; 
                carousel.style.transition = 'none'; 
                stopAutoRotate(); 
            };
            
            const dragging = (e) => { 
                if (!isCarouselDragging) return; 
                const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX; 
                const diffX = currentX - startX; 
                const sensitivity = window.innerWidth <= 850 ? 0.7 : 0.5; 
                targetRotation = currentRotation + diffX * sensitivity; 
                carousel.style.transform = `rotateY(${targetRotation}deg)`; 
            };
            
            const dragEnd = () => { 
                if (!isCarouselDragging) return; 
                isCarouselDragging = false; 
                carousel.style.transition = 'transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; 
                currentRotation = targetRotation; 
                restartAutoRotateWithDelay(); 
            };
            
            const animateRotation = () => { 
                if (isCarouselDragging) return; 
                const rotationSpeed = 0.28; 
                targetRotation -= rotationSpeed; 
                currentRotation -= rotationSpeed; 
                carousel.style.transform = `rotateY(${targetRotation}deg)`; 
                animationFrameId = requestAnimationFrame(animateRotation); 
            };
            
            const stopAutoRotate = () => { 
                if (animationFrameId) cancelAnimationFrame(animationFrameId); 
                clearTimeout(autoRotateTimeout); 
            };
            
            const startAutoRotate = () => { 
                stopAutoRotate(); 
                animationFrameId = requestAnimationFrame(animateRotation); 
            };
            
            const restartAutoRotateWithDelay = () => { 
                stopAutoRotate(); 
                autoRotateTimeout = setTimeout(startAutoRotate, 3000); 
            };
            
            carousel.addEventListener('mousedown', dragStart); 
            document.addEventListener('mousemove', dragging); 
            document.addEventListener('mouseup', dragEnd);
            carousel.addEventListener('touchstart', dragStart, { passive: true }); 
            carousel.addEventListener('touchmove', dragging, { passive: true }); 
            carousel.addEventListener('touchend', dragEnd);
            
            const modalObserver = new MutationObserver(mutations => { 
                mutations.forEach(mutation => { 
                    if (mutation.attributeName === 'class') { 
                        const isActive = mutation.target.classList.contains('active'); 
                        if (isActive) { 
                            arrangeItems(); 
                            startAutoRotate(); 
                        } else { 
                            stopAutoRotate(); 
                        } 
                    } 
                }); 
            });
            modalObserver.observe(modalContainer, { attributes: true });
            window.addEventListener('resize', arrangeItems);
        }
    }

    // Inicializar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init3D);
    } else {
        init3D();
    }
</script>
</body>
</html>